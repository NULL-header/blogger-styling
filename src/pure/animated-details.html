<html schema="component">

<head>
    <template>
        <style>
            ::slotted(*:not(:first-child)) {
                animation: var(--animation-name);
            }
        </style>
        <details part="details">
            <summary part="summary">
                <slot name="summary"></slot>
            </summary>
            <slot></slot>
        </details>
    </template>
    <script>
        const closingAnim = (target) => [
            {
                height: target.offsetHeight + "px",
            },
            {
                height: 0,
            },
        ];

        const openingAnim = (target) => [
            {
                height: 0,
            },
            {
                height: target.offsetHeight + "px",
            },
        ];

        const getAnimOption = (target) => {
            const style = getComputedStyle(target)
            const duration = (style.animationDuration.slice(0, -1)) * 1000;
            const easing = style.animationTimingFunction;
            return { duration, easing, }
        }

        class AnimatedDetails extends HTMLElement {
            constructor() {
                super()
                const template = document.createElement("template");
                template.innerHTML = __MARKER__;
                shadow.appendChild(template.content.cloneNode(true))
                const shadow = this.attachShadow({ mode: "closed" })
                const detailElement = shadow.querySelector("details")
                const slotElement = detailElement.children[1];
                this.detailElement = detailElement;
                this.slotElement = slotElement;
            }
            connectedCallback() {
                const openKeyframe = this.dataset.openKeyframe;
                const closeKeyframe = this.dataset.closeKeyframe;
                if (openKeyframe == null || closeKeyframe == null) {
                    return
                }
                this.detailElement.addEventListener("click", (e) => {
                    e.preventDefault();
                    const target = this.slotElement.assignedElements()[0];
                    if (target == null) {
                        return
                    }
                    const animOption = getAnimOption(target)
                    if (this.detailElement.getAttribute("open") != null) {
                        target.style.setProperty("--animation-name", closeKeyframe)
                        const animating = target.animate(closingAnim(target), animOption)
                        animating.addEventListener("finish", () => {
                            this.detailElement.removeAttribute("open")
                        })
                        return
                    }
                    this.detailElement.setAttribute("open", "");
                    target.style.setProperty("--animation-name", openKeyframe)
                    const animating = target.animate(openingAnim(target), animOption)
                })
            }
        }
        customElements.define("animated-details", AnimatedDetails)
    </script>
</head>

</html>